<!DOCTYPE html>
<html ng-app="app">
<head>
    <title>Hello world</title>

    <style type="text/css">

        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }

        .ng-map {
            width: 100%;
            height: 100%;
        }

        [class^="ng-map-"],
        [class*=" ng-map-"] {
            display: none;
        }

        .marker {
            width: 16px;
            height: 16px;
            background: #3F7FEF;
            text-align: center;
            border-radius: 50%;
            cursor: move;
            box-shadow: 0 1px 4px rgba(0,0,0,0.4);

            -webkit-transition: box-shadow .2s;
        }

    </style>
</head>
<body ng-controller="AppCtrl">
    <div class="ng-map" options="{scaleControl: true}" event-ready="AppCtrl.ready($ngMap)">
        <div class="ng-map-center" lat="54.60786894786166" lng="38.16925048828125"></div>
        <div class="ng-map-zoom" value="13"></div>

        <div class="ng-map-polyline" path="AppCtrl.path" color="'#444444'" weight="7"></div>
        <div class="ng-map-polyline" path="AppCtrl.progressPath" color="'#3F7FEF'" weight="7"></div>

        <div class="ng-map-marker" lat="AppCtrl.markerPosition.lat()" lng="AppCtrl.markerPosition.lng()" draggable="true" event-drag="AppCtrl.onDrag($event, $ngMap)">
            <div class="marker"></div>
        </div>
    </div>

    <script type="text/javascript" src="/vendor.js"></script>
    <script type="text/javascript" src="/angular-maps.js"></script>
    <script type="text/javascript">

        // point, segment: p1, p2
        function closestPointOnSegment(p, p1, p2, sqDist) {
            var x = p1.x,
                y = p1.y,
                dx = p2.x - x,
                dy = p2.y - y,
                dot = dx * dx + dy * dy,
                t;

            if (dot > 0) {
                t = ((p.x - x) * dx + (p.y - y) * dy) / dot;

                if (t > 1) {
                    x = p2.x;
                    y = p2.y;
                } else if (t > 0) {
                    x += dx * t;
                    y += dy * t;
                }
            }

            dx = p.x - x;
            dy = p.y - y;

            return sqDist ? dx * dx + dy * dy : {x: x, y: y};
        }

        function distance( point1, point2 ){
            var xs = 0;
            var ys = 0;

            xs = point2.x - point1.x;
            xs = xs * xs;

            ys = point2.y - point1.y;
            ys = ys * ys;

            return Math.sqrt( xs + ys );
        }

        angular.module('app', ["ngMaps"])

            .controller("AppCtrl", function($scope, $timeout){
                $scope.AppCtrl = this;
                self = this

                this.path = [[54.661283333,38.148983333],[54.6618,38.148483333],[54.662466667,38.148433333],[54.663116667,38.148683333],[54.66395,38.148333333],[54.664416667,38.14845],[54.665233333,38.148366667],[54.665366667,38.148083333],[54.66545,38.148383333],[54.665366667,38.148966667],[54.664783333,38.15055],[54.66415,38.151633333],[54.66245,38.153866667],[54.660933333,38.155533333],[54.65945,38.156516667],[54.6589,38.156633333],[54.6582,38.156533333],[54.658016667,38.156366667],[54.657783333,38.15565],[54.657983333,38.155616667],[54.65805,38.155283333],[54.658,38.15485],[54.658083333,38.154516667],[54.658266667,38.154583333],[54.658616667,38.153833333],[54.6587,38.154116667],[54.658583333,38.154616667],[54.658166667,38.155033333],[54.657683333,38.1549],[54.657466667,38.1547],[54.657366667,38.154433333],[54.657366667,38.154033333],[54.657583333,38.154133333],[54.65725,38.154866667],[54.65675,38.155066667],[54.656366667,38.154733333],[54.656283333,38.154316667],[54.6565,38.154333333],[54.65635,38.155183333],[54.6559,38.155583333],[54.65565,38.155516667],[54.655466667,38.155283333],[54.65535,38.154866667],[54.655533333,38.15465],[54.65575,38.1548],[54.655366667,38.155783333],[54.655133333,38.155783333],[54.6548,38.155433333],[54.65475,38.155116667],[54.6549,38.154816667],[54.655933333,38.155066667],[54.65615,38.155916667],[54.655733333,38.1564],[54.655466667,38.156466667],[54.65525,38.156316667],[54.655616667,38.155833333],[54.655616667,38.15615],[54.655316667,38.156783333],[54.654816667,38.157083333],[54.654416667,38.156883333],[54.6543,38.156516667],[54.654316667,38.15745],[54.6539,38.158033333],[54.653466667,38.15805],[54.653183333,38.157766667],[54.653116667,38.157416667],[54.6533,38.158216667],[54.65295,38.15925],[54.6527,38.159533333],[54.652183333,38.15965],[54.651766667,38.159416667],[54.6513,38.158766667],[54.651066667,38.158],[54.650383333,38.156533333],[54.64935,38.154966667],[54.649166667,38.154866667],[54.648733333,38.154966667],[54.64855,38.155166667],[54.64845,38.1555],[54.648466667,38.155833333],[54.648633333,38.156],[54.648766667,38.155733333],[54.64835,38.155133333],[54.647816667,38.155216667],[54.647333333,38.155116667],[54.647066667,38.154633333],[54.64705,38.155333333],[54.646733333,38.156],[54.64645,38.1562],[54.6462,38.15615],[54.645816667,38.155833333],[54.645733333,38.1555],[54.645666667,38.156233333],[54.645316667,38.1569],[54.6448,38.157133333],[54.644366667,38.156933333],[54.644183333,38.156566667],[54.644166667,38.157583333],[54.643666667,38.1585],[54.643183333,38.158783333],[54.64275,38.158666667],[54.64255,38.1583],[54.64265,38.159066667],[54.642533333,38.159366667],[54.642133333,38.15985],[54.641883333,38.15995],[54.641683333,38.159833333],[54.641533333,38.159466667],[54.641616667,38.160216667],[54.64125,38.160733333],[54.640766667,38.160766667],[54.640516667,38.1604],[54.640533333,38.160083333],[54.640783333,38.160416667],[54.640733333,38.161466667],[54.640383333,38.162083333],[54.639933333,38.162266667],[54.6397,38.161983333],[54.639883333,38.1619],[54.640033333,38.162766667],[54.639783333,38.163466667],[54.639583333,38.163716667],[54.63935,38.1638],[54.639066667,38.163666667],[54.639083333,38.163333333],[54.639283333,38.1642],[54.6391,38.1649],[54.638716667,38.165383333],[54.638316667,38.165416667],[54.638083333,38.16515],[54.6381,38.1648],[54.63835,38.165],[54.6384,38.165933333],[54.638166667,38.1666],[54.63775,38.16715],[54.6371,38.1672],[54.63555,38.16635],[54.635433333,38.166016667],[54.635633333,38.165833333],[54.635766667,38.166233333],[54.635633333,38.16695],[54.635316667,38.167533333],[54.634666667,38.168083333],[54.63405,38.167916667],[54.633883333,38.167516667],[54.6339,38.1672],[54.634116667,38.167183333],[54.634266667,38.167566667],[54.634183333,38.16855],[54.633866667,38.169183333],[54.6332,38.16955],[54.63265,38.169316667],[54.632533333,38.1689],[54.632616667,38.168583333],[54.63285,38.168733333],[54.632716667,38.169733333],[54.632366667,38.170383333],[54.63125,38.1714],[54.630783333,38.171566667],[54.6303,38.17155],[54.629383333,38.1712],[54.62865,38.1706],[54.627933333,38.169366667],[54.627983333,38.170283333],[54.627616667,38.170983333],[54.6269,38.1713],[54.626466667,38.1711],[54.626283333,38.170716667],[54.626383333,38.170433333],[54.626533333,38.17065],[54.626516667,38.17165],[54.626183333,38.172366667],[54.6257,38.1728],[54.625466667,38.17285],[54.623116667,38.172],[54.622366667,38.1719],[54.6212,38.1715],[54.620633333,38.171083333],[54.62045,38.1707],[54.6205,38.170383333],[54.620683333,38.170633333],[54.620583333,38.1715],[54.620216667,38.172183333],[54.619733333,38.172533333],[54.619233333,38.172516667],[54.618783333,38.172083333],[54.618683333,38.171766667],[54.618683333,38.171383333],[54.619083333,38.170216667],[54.619433333,38.169833333],[54.620016667,38.169533333],[54.620633333,38.168883333],[54.620716667,38.1685],[54.620533333,38.168033333],[54.619966667,38.167516667],[54.618566667,38.166916667],[54.617283333,38.16705],[54.613716667,38.165583333],[54.61355,38.165383333],[54.6135,38.166133333],[54.61315,38.166633333],[54.612766667,38.166616667],[54.612533333,38.1663],[54.612366667,38.167133333],[54.612166667,38.1675],[54.61145,38.168033333],[54.61085,38.16775],[54.6107,38.168483333],[54.6103,38.169066667],[54.609816667,38.169333333],[54.60905,38.16935],[54.606333333,38.168633333],[54.603716667,38.167383333],[54.603566667,38.167016667],[54.603483333,38.167666667],[54.603283333,38.1679],[54.60275,38.167966667],[54.602383333,38.1676],[54.6023,38.167233333],[54.602183333,38.167916667],[54.60175,38.168333333],[54.601216667,38.16835],[54.601016667,38.1682],[54.600816667,38.1678],[54.600766667,38.16845],[54.600566667,38.168716667],[54.60005,38.168916667],[54.599633333,38.168683333],[54.599466667,38.16825],[54.599366667,38.168833333],[54.598933333,38.169216667],[54.598483333,38.169133333],[54.598316667,38.16895],[54.598183333,38.168566667],[54.598033333,38.169433333],[54.5976,38.169766667],[54.596583333,38.169733333],[54.595966667,38.169266667],[54.5939,38.168533333],[54.59065,38.16775],[54.58925,38.167566667],[54.584183333,38.167866667],[54.57995,38.16795],[54.576033333,38.1685],[54.574783333,38.168833333],[54.5741,38.168683333],[54.5729,38.167683333],[54.5722,38.167266667],[54.571216667,38.1669],[54.5665,38.166533333],[54.56525,38.166583333],[54.562616667,38.16605],[54.560466667,38.165133333],[54.5583,38.164716667],[54.556933333,38.1643],[54.55525,38.164083333],[54.553966667,38.164266667],[54.55235,38.165266667],[54.54965,38.165983333],[54.548966667,38.165883333],[54.548716667,38.1656],[54.548783333,38.166066667],[54.548366667,38.167066667],[54.5481,38.167316667],[54.547616667,38.167466667],[54.547383333,38.1674],[54.547166667,38.167133333],[54.54735,38.16785],[54.5473,38.168183333],[54.547016667,38.16885],[54.546833333,38.169066667],[54.546383333,38.1692],[54.546,38.169083333],[54.545783333,38.168816667],[54.545883333,38.1697],[54.5456,38.170366667],[54.545116667,38.170733333],[54.544683333,38.170666667],[54.544483333,38.1704],[54.544566667,38.1712],[54.544416667,38.171566667],[54.544,38.172066667],[54.543766667,38.172183333],[54.543383333,38.172083333],[54.543233333,38.17175],[54.543416667,38.1724],[54.543333333,38.173133333],[54.542916667,38.17375],[54.5424,38.174016667],[54.542,38.17385],[54.541833333,38.173516667],[54.541966667,38.174366667],[54.54185,38.17475],[54.54145,38.175333333],[54.541183333,38.175466667],[54.54075,38.175366667],[54.5406,38.175066667],[54.540733333,38.175933333],[54.540566667,38.176283333],[54.540116667,38.176683333],[54.539666667,38.176666667],[54.5395,38.17645],[54.539633333,38.177016667],[54.539566667,38.177366667],[54.539233333,38.178016667],[54.53875,38.178283333],[54.538533333,38.178183333],[54.53835,38.177883333],[54.53835,38.178566667],[54.538216667,38.178983333],[54.537716667,38.179366667],[54.537316667,38.179233333],[54.537333333,38.1798],[54.537216667,38.180216667],[54.53675,38.180733333],[54.536016667,38.1807],[54.535783333,38.180316667],[54.535833333,38.180866667],[54.535516667,38.18165],[54.534766667,38.182333333],[54.534333333,38.1823],[54.534083333,38.18205],[54.534183333,38.182633333],[54.53405,38.183033333],[54.533566667,38.183616667],[54.532866667,38.1838],[54.5327,38.183533333],[54.532866667,38.184216667],[54.5328,38.184633333]];
                this.timeMap = [1375524845,1375524867,1375524883,1375524899,1375524919,1375524929,1375524945,1375524955,1375524961,1375524965,1375524975,1375524983,1375525001,1375525015,1375525027,1375525031,1375525037,1375525039,1375525047,1375525057,1375525065,1375525071,1375525077,1375525085,1375525105,1375525109,1375525113,1375525117,1375525121,1375525123,1375525125,1375525129,1375525137,1375525143,1375525147,1375525151,1375525155,1375525161,1375525167,1375525171,1375525173,1375525175,1375525179,1375525187,1375525193,1375525201,1375525203,1375525207,1375525211,1375525217,1375525251,1375525267,1375525271,1375525273,1375525275,1375525305,1375525307,1375525311,1375525315,1375525319,1375525323,1375525335,1375525339,1375525343,1375525347,1375525353,1375525363,1375525369,1375525371,1375525375,1375525379,1375525387,1375525395,1375525415,1375525435,1375525437,1375525441,1375525443,1375525445,1375525447,1375525451,1375525455,1375525463,1375525467,1375525471,1375525477,1375525485,1375525489,1375525491,1375525493,1375525497,1375525501,1375525509,1375525513,1375525517,1375525521,1375525525,1375525537,1375525543,1375525547,1375525551,1375525555,1375525567,1375525569,1375525573,1375525575,1375525577,1375525581,1375525591,1375525595,1375525599,1375525603,1375525607,1375525613,1375525619,1375525623,1375525627,1375525631,1375525637,1375525643,1375525647,1375525649,1375525651,1375525655,1375525661,1375525669,1375525673,1375525677,1375525681,1375525685,1375525691,1375525697,1375525703,1375525707,1375525711,1375525717,1375525735,1375525739,1375525745,1375525749,1375525753,1375525757,1375525763,1375525769,1375525773,1375525777,1375525781,1375525785,1375525791,1375525795,1375525801,1375525807,1375525811,1375525817,1375525823,1375525829,1375525833,1375525843,1375525847,1375525851,1375525859,1375525867,1375525879,1375525895,1375525899,1375525905,1375525909,1375525913,1375525919,1375525923,1375525929,1375525933,1375525937,1375525939,1375525959,1375525965,1375525975,1375525981,1375525985,1375525993,1375526001,1375526007,1375526011,1375526015,1375526019,1375526025,1375526029,1375526035,1375526063,1375526077,1375526097,1375526115,1375526121,1375526125,1375526131,1375526143,1375526153,1375526187,1375526191,1375526199,1375526203,1375526207,1375526211,1375526227,1375526229,1375526235,1375526241,1375526255,1375526259,1375526263,1375526269,1375526291,1375526313,1375526317,1375526325,1375526327,1375526331,1375526335,1375526339,1375526347,1375526351,1375526355,1375526357,1375526361,1375526371,1375526373,1375526377,1375526381,1375526385,1375526397,1375526401,1375526405,1375526407,1375526411,1375526421,1375526425,1375526433,1375526439,1375526455,1375526479,1375526489,1375526525,1375526557,1375526587,1375526597,1375526603,1375526615,1375526621,1375526629,1375526665,1375526675,1375526697,1375526717,1375526737,1375526749,1375526763,1375526773,1375526785,1375526805,1375526811,1375526815,1375526825,1375526831,1375526833,1375526837,1375526839,1375526843,1375526857,1375526859,1375526863,1375526865,1375526869,1375526873,1375526877,1375526889,1375526893,1375526897,1375526901,1375526905,1375526917,1375526919,1375526923,1375526925,1375526929,1375526933,1375526945,1375526949,1375526953,1375526957,1375526961,1375526965,1375526977,1375526979,1375526983,1375526985,1375526989,1375526993,1375527003,1375527005,1375527009,1375527013,1375527017,1375527025,1375527027,1375527031,1375527035,1375527037,1375527041,1375527051,1375527053,1375527057,1375527061,1375527071,1375527073,1375527077,1375527083,1375527087,1375527097,1375527101,1375527107,1375527111,1375527115,1375527127,1375527129,1375527133,1375527139,1375527143,1375527151,1375527153];

                this.time = 1000;

                this.onDrag = function($event, ctrl) {
                    var projection, distances, position, segments, min, index, timeIndex;
                    $event.preventDefault();

                    projection = ctrl.map.getProjection();
                    position = projection.fromLatLngToPoint($event.position);
                    segments = []

                    for (var i = 0; i < self.path.length; i++) {
                        var p, current, prev;

                        p = self.path[i];
                        current = {};

                        current.end = projection.fromLatLngToPoint(
                            new ctrl.api.LatLng(p[0], p[1])
                        );

                        if (prev = segments[i-1]) {
                            current.start = prev.end;
                            current.closest = closestPointOnSegment(position, current.start, current.end);
                            current.dist = closestPointOnSegment(position, current.start, current.end, true);
                        } else {
                            current.start = current.end;
                            current.closest = current.end;
                            current.dist = distance(current.end, position);
                        }

                        segments.push(current);
                    };

                    min = segments[0];
                    index = 0;

                    for (var i = 0; i < segments.length; i++) {
                        if (segments[i].dist < min.dist) {
                            min = segments[i];
                            index = i;
                        }
                    };

                    timeIndex = (index-1) || 0;
                    time = self.timeMap[timeIndex] - self.timeMap[0];
                    fraction = distance(min.start, min.closest) / distance(min.start, min.end);
                    offset = (self.timeMap[index] - self.timeMap[timeIndex]) * fraction;

                    $timeout(function(){
                        self.time = time + offset;
                        self.markerPosition = projection.fromPointToLatLng(min.closest);
                    });
                }

                this.ready = function(ctrl){

                    var once = true;

                    $scope.$watch(function(){
                        return self.time
                    }, function(time){
                        var duration = self.timeMap[self.timeMap.length-1]-self.timeMap[0],
                            currentTime = time,
                            limit = self.timeMap[0] + currentTime,
                            currentIndex = 0;

                        for (var i = 0; i < self.timeMap.length; i++) {
                            if (self.timeMap[i] > limit ) {
                                currentIndex = i;
                                break;
                            }
                        };

                        if (currentIndex > 0)
                            currentIndex = currentIndex - 1

                        var fraction = (limit - self.timeMap[currentIndex]) / (self.timeMap[currentIndex+1] - self.timeMap[currentIndex]),
                            from = new ctrl.api.LatLng(self.path[currentIndex][0], self.path[currentIndex][1]),
                            to = new ctrl.api.LatLng(self.path[currentIndex+1][0], self.path[currentIndex+1][1]),
                            mid = ctrl.api.geometry.spherical.interpolate(from, to, fraction);

                        self.progressPath = self.path.slice(0, currentIndex + 1)
                        self.progressPath.push([mid.lat(), mid.lng()]);

                        if (once) {
                            self.markerPosition = mid;
                            once = false;
                        }

                        // console.log(self.progressPath);
                    });

                    // $timeout(function updateTime(){
                    //     self.time += 0.1;
                    //     $timeout(updateTime, 100);
                    // }, 100)

                };



            });
    </script>
</body>
</html>